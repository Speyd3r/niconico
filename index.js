var EventEmitter,Promise,_,async,fs,parseString,path,querystring,request;async=require("async"),fs=require("fs"),path=require("path"),querystring=require("querystring"),request=require("request"),parseString=require("xml2js").parseString,EventEmitter=require("events").EventEmitter,Promise=require("promise"),_=require("underscore"),request=request.defaults({jar:!0}),function(){"use strict";var e;return e=function(){function e(e){this.email=e.email,this.password=e.password,this.output=e.output}return e.prototype.sign_in=function(){return new Promise(function(t,i){var o;o={url:"https://secure.nicovideo.jp/secure/login?site=niconico",form:{mail:e.email,password:e.password}},request.post(o,function(e,o){return e?void i(o.statusCode):(console.log("Login success",o.statusCode),void t(o.statusCode))})})},e.prototype.get_video=function(e){return new Promise(function(t,i){var o;o={url:"http://www.nicovideo.jp/watch/"+e},request.get(o,function(e,o){return e?void i(o.statusCode):(console.log("Video page accessing is success",o.statusCode),void t(o.statusCode))})})},e.prototype.get_flv=function(e){return new Promise(function(t,i){var o;o={url:"http://www.nicovideo.jp/api/getflv?v="+e},request.get(o,function(e,o,n){var r;return e?void i(o.statusCode):(console.log("getflv",n),r={thread_id:n.split("&")[0].split("=")[1],url:querystring.unescape(n.split("&")[2].split("=")[1])},void t(r))})})},e.prototype.get_thumbinfo=function(e){return new Promise(function(t,i){var o;o={url:"http://ext.nicovideo.jp/api/getthumbinfo/"+e},request.get(o,function(e,o,n){return e?void i(o.statusCode):void parseString(n,function(o,n){var r;return o?void i(e):(r={video_id:n.nicovideo_thumb_response.thumb[0].video_id[0],title:n.nicovideo_thumb_response.thumb[0].title[0],description:n.nicovideo_thumb_response.thumb[0].description[0],watch_url:n.nicovideo_thumb_response.thumb[0].watch_url[0],movie_type:n.nicovideo_thumb_response.thumb[0].movie_type[0]},void t(r))})})})},e.prototype.http_export=function(e,t){return new Promise(function(i){request.head(e,function(){var o;o=request(e).pipe(fs.createWriteStream(t)),o.on("finish",i)})})},e.prototype.download=function(e){return new Promise(function(t){var i,o;i={},o=this,this.sign_in().then(function(){o.get_video(e)}).then(function(){o.get_flv(e)}).then(function(t){i=_.extend(i,t),o.get_thumbinfo(e)}).then(function(e){var t,n;i=_.extend(i,e),t=i.title.replace(/\//g,"Ôºè"),n=""+t+"."+i.movie_type,i.filepath=path.resolve(path.join(o.output,n)),http_export(i.url,i.filepath)}).then(function(){t(i.filepath)}).done()})},e}()}(function(){var e;"object"==typeof exports?module.exports=definition():"function"==typeof define&&define.amd?define(definition):e=definition()}),module.exports=Nicovideo;